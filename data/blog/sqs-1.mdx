---
title: SQS(1) - AWS SQS 문서 핵심 정리
date: '2023-07-24'
tags: ['AWS', 'SQS']
draft: false
summary: AWS SQS 문서 핵심 정리
---

## SQS

SQS는 AWS에서 제공하는 완전관리형 메시지 대기열이다.

## 대기열 유형

### 표준 대기열

- **at-least-once(최소 한번)** 메시지 전달을 지원한다.
- 메시지가 일반적으로 전송된 순서와 동일한 순서로 전달되도록 하지만, 이를 보장하지 않는다.
  - 시스템에서 순서를 유지해야할 경우, FIFO 대기열을 사용하거나, 메시지에 시퀀스 정보를 추가하여, 재정렬 될 수 있도록 처리가 필요하다.
  - 고가용성을 위해 여러대의 서버에 메시지 사본을 저장하기 때문이다.
  - 여러 서버중 하나의 서버에 문제가 생겨, 완료(성공)된 메시지가 삭제되지 않는 경우가 있을수 있다. 이미 처리된 메시지가 다시 전달되는 경우에 대비하여 중복해서 처리되지 않도록 해야한다. (멱등성)

### FIFO(first-in first-out) 대기열

- 표준대기열의 모든 기능을 갖추고 있으면서, 순서가 중요하거나 중복 메시지가 발생하면 안되는 경우에 사용한다.
  - 정확히 한번만 처리되지만, TPS는 제한되어 있다. (300TPS/메시지그룹, 일괄처리시 3,000TPS/메시지그룹)
- **메시지 그룹ID**별로 정렬된다. 메시지그룹이 다를경우, 순서가 보장되지 않는다.
- fifo 대기열 내 메시지 그룹의 수는 제한이 없다.
- 데이터 중복 제거 간격(설정 가능) 내 sendMessage 작업을 해도, 중복 항목을 추가하지 않는다.

## 특징 및 기능

### 짧은 폴링과 긴 폴링

- ~~(이 부분은 좀 더 자세히 찾아보고 정리해보자)~~

### SQS dead letter queue (DLQ)

- 성공적으로 처리하지 못한 메시지를 DLQ로 분리하여, 실패 분석 및 시스템 디버깅을 위해 사용한다.
  - 디버깅 완료 후, DLQ 리드라이브를 통해 다시 소스 큐로 이동할 수 있다.
- maxReceiveCount: 실패한 메시지를 DLQ로 보내기 전, 시도할 수 있는 최대 횟수를 설정한다.
  - 1~1000 사이의 값을 설정할 수 있다.
  - 1로 설정하면, 실패한 메시지를 바로 DLQ로 보낸다.
  - _3정도로 설정하는게 가장 좋아 보인다._
- FIFO 대기열의 DLQ 역시 FIFO 대기열이어야 한다.
- 마찬가지로 표준 대기열의 DLQ 역시 표준 대기열이어야 한다.
- DLQ로 이동하는 메시지에 대하 SNS등을 통해 알림을 보낼수 있다.

### 제한 시간

- 메시지를 수신한 직후에 메시지는 대기열에 그대로 있다.
- 다른 컨슈머가 메시지를 처리할 수 없도록(이미 다른 컨슈머가 가져간 메시지)를 처리할 수 없도록 기간 설정을 해야한다.
  - 표시 제한 시간 (기본 30초, 최소0초 ~ 최대 12시간)

### 메시지의 기본 라이프 사이클

- 생성자가 대기열로 메시지 전송
  - 컨슈머가 수신하기 전까지, `저장된 메시지`로 처리
- 컨슈머가 대기열에서 메시지 수신
  - 컨슈머가 대기열에서 메시지를 수신했지만, 삭제되지 않는 메시지를 `전송중`으로 처리
- 성공시, 컨슈머가 대기열에서 메시지 삭제
- 실패시, 컨슈머가 maxReceiveCount만큼 재시도 하다가, 메시지 DLQ로 이동

### 지연 대기열 (메시지 타이머)

- 대기열에 쌓여있는 메시지를 컨슈머에게 전송하는 것을 특정 시간 동안 연기할 수 있다.

---

## 참고자료

- [Amazon Simple Queue Service](https://docs.aws.amazon.com/ko_kr/AWSSimpleQueueService/latest/SQSDeveloperGuide/welcome.html)
- https://aws.amazon.com/ko/blogs/compute/solving-complex-ordering-challenges-with-amazon-sqs-fifo-queues/
